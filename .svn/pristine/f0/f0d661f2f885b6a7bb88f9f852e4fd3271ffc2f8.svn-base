using System;
using System.Collections.Generic;
using System.Linq;
using System.Reflection;
using System.Text;
using System.Threading;
using System.Threading.Tasks;
using System.Windows.Forms;
using JFInterfaceDef;
using JFToolKits;
namespace JFHub
{

    /// <summary>
    /// 产品加工完成消息
    /// </summary>
    /// <param name="station">消息发送者</param>
    /// <param name="PassCount">本次生产完成的成品数量</param>
    /// <param name="NGCount">本次生产的次品数量</param>
    /// <param name="NGInfo">次品信息</param>
    public delegate void DelegateStationProductFinished(IJFStation station, int passCount,string[] passIDs, int NGCount, string[] ngIDs,string[] NGInfo);

    /// <summary>
    /// 代理：向外部程序发送定制消息
    /// </summary>
    /// <param name="station"></param>
    /// <param name="msg"></param>
    public delegate void DelegateStationCustomizeMsg(IJFStation station, string msgCategory,object msgParam);


    public abstract class JFStationBase : JFCmdWorkBase, IJFStation
    {
        public JFStationBase()
        {
            //Name = "";
            DeclearCfgParam(JFParamDescribe.Create("工站归零模式", typeof(string), JFValueLimit.Options, _resetModes), "工站基础配置");
            SetCfgParamValue("工站归零模式", _resetModes[0]);//默认模式为：每次运行前都要归零1次
            _cfgFilePath = null;
            _cfg = new JFXCfg();
            IsInitOK = false;
            _ui = new UcStationBaseRealtimeUI();
            _ui.SetStation(this);

        }
        string[] _resetModes = new string[] { "每次运行前必须归零", "程序启动后只运行一次", "运行前不检查是否归零" };

        public DelegateStationProductFinished EventProductFinished;
        public DelegateStationCustomizeMsg EventCustomizeMsg;

        int _standardAxisCount = 0; //标准轴数量
        public int StandardAxisCount { get { return _standardAxisCount; } }

        string _initErrorInfo = "No-Ops"; //初始化动作失败信息

       

        string _cfgFilePath; //工站配置文件名称
        JFXCfg _cfg = null;
        /// <summary>
        /// 用于保存工站私有配置数据
        /// </summary>
        public JFXCfg Config { get { return _cfg; } }

        Dictionary<string, JFMethodFlow> _dictMethodFlow = new Dictionary<string, JFMethodFlow>();//List<JFMethodFlow> _lstMethodFlowsInCfg = new List<JFMethodFlow>(); //可增删改的工作流(包括注册工作流)


        string _stationName = null;
        public override string Name //JFCmdWorkBase.Name
        {
            get 
            { 
                string nameInCfg = JFHubCenter.Instance.InitorManager.GetIDByInitor(this);
                return nameInCfg != null ? nameInCfg : _stationName;
            }
            set 
            {
                if(null != JFHubCenter.Instance.InitorManager.GetIDByInitor(this)) //对已经存在于Initor管理器中的工站，不能修改名称
                    return;
                _stationName = value;
            } 
        }

        string IJFWork.Name //IJFStation.Name
        {
            get { return Name; }
            set { Name = value; }
        }

        JFDataPool _workFlowDataPool = new JFDataPool();
        /// <summary>
        /// 工站内部工作流共用的数据池
        /// </summary>
        public JFDataPool DataPool{ get { return _workFlowDataPool; } }

        #region IJFInitializable's API



        string[] _stationBaseInitParams = new string[] { //"工站名称", //工站名称 
                                                         "配置文件",//配置文件路径
                                                         "标准轴数"//标准轴为 X，Y，Z，R， 可选值0，1，2，3，4
                                                        };
        /// <summary>获取初始化需要的所有参数的名称 </summary>
        public virtual string[] InitParamNames { get { return _stationBaseInitParams; } }

        /// <summary>
        /// 检查初始化参数名称是否合法
        /// 如果InitParamNames未包含initParamName 会抛出异常
        /// </summary>
        /// <param name="initParamName"></param>
        protected void CheckInitParamName(string initParamName,string function = null)
        {
            if (string.IsNullOrEmpty(initParamName))
                throw new ArgumentNullException("initParamName is null or empty" + function == null ? "" : (" in StationName=" + Name + " 's function()"));
            if(!InitParamNames.Contains(initParamName))
                throw new ArgumentNullException("initParamName is not contained by ParamName's List, " + function == null ? "" : ("StationName=" + Name + " 's function()"));
        }
        /// <summary>
        /// 获取指定名称的初始化参数的信息
        /// </summary>
        /// <param name="name"></param>
        /// <returns></returns>
        public virtual JFParamDescribe GetInitParamDescribe(string name)
        {
            CheckInitParamName(name, "GetInitParamDescribe");
            //if (name == _stationBaseInitParams[0])
            //    return JFParamDescribe.Create(_stationBaseInitParams[0], typeof(string), JFValueLimit.NonLimit,null);
            /*else */if (name == _stationBaseInitParams[0])
                return JFParamDescribe.Create(_stationBaseInitParams[0], typeof(string), JFValueLimit.FilePath, null);
            else if(name == _stationBaseInitParams[1]) //工站中所包含的标准轴数（X，Y，Z，R）
                return JFParamDescribe.Create(_stationBaseInitParams[1], typeof(int), JFValueLimit.Options, new object[] { 0,1,2,3,4});
            throw new Exception();//不可能运行到这一步
        }

        /// <summary>
        /// 获取指定名称的初始化参数的当前值
        /// </summary>
        /// <param name="name">参数名称，如果参数名称不在InitParamNames中，将会抛出一个ArgumentException异常</param>
        /// <returns>参数值</returns>
        public virtual object GetInitParamValue(string name)
        {
            CheckInitParamName(name, "GetInitParamValue");
            //if (name == _stationBaseInitParams[0])
            //    return Name;
            /*else */if (name == _stationBaseInitParams[0])
                return _cfgFilePath;
            else if (name == _stationBaseInitParams[1])
                return _standardAxisCount;
            throw new Exception();//不可能运行到这一步
        }

        /// <summary>
        ///设置取指定名称的初始化参数的当前值
        /// </summary>
        /// <param name="name">参数名称，如果参数名称不在InitParamNames中，将会抛出一个ArgumentException异常</param>
        /// <param name="value">参数值</param>
        /// <returns>操作成功返回True，失败返回false，可通过GetInitErrorInfo()获取错误信息</returns>
        public virtual bool SetInitParamValue(string name, object value)
        {
            CheckInitParamName(name, "SetInitParamValue");
            if(name == _stationBaseInitParams[0])
            {
                if(null == value)
                {
                    _initErrorInfo = "SetInitParamValue(name = " + "\"" + name + "\",value) falied by: value = null";
                    return false;
                }
                if (!typeof(string).IsAssignableFrom(value.GetType()))
                {
                    _initErrorInfo = "SetInitParamValue(name = " + "\"" + name + "\",value) falied by: value's type = " + value.GetType().Name + " is not Assignable to string";
                    return false;
                }
                _cfgFilePath = value as string;
                _initErrorInfo = "Success";
                return true;
            }
            else if (name == _stationBaseInitParams[1])
            {
                if (null == value)
                {
                    _initErrorInfo = "SetInitParamValue(name = " + "\"" + name + "\",value) falied by: value = null";
                    return false;
                }

                int nValue = 0;
                if (typeof(int) == value.GetType())
                    nValue = (int)value;

                else if (JFTypeExt.IsExplicitFrom(typeof(int), value.GetType()))
                    nValue = (int)JFConvertExt.ChangeType(value, typeof(int));
                else
                {
                    _initErrorInfo = "SetInitParamValue(name = " + "\"" + name + "\",value) falied by: value's type = " + value.GetType().Name + " can not Changeto int";
                    return false;
                }

                if (nValue < 0 || nValue > 4)
                {
                    _initErrorInfo = "SetInitParamValue(name = " + "\"" + name + "\",value) falied by: value = " + nValue + " is outof range 0~4";
                    return false;
                }
                _standardAxisCount = nValue;
                return true;
            }
            throw new Exception();
        }

        
        /// <summary>
        /// 对象初始化
        /// </summary>
        /// <returns>操作成功返回True，失败返回false，可通过GetInitErrorInfo()获取错误信息</returns>
        public virtual bool Initialize()
        {

            if (string.IsNullOrEmpty(_cfgFilePath))
            {
                _initErrorInfo = "Initialize Failed by: Station's CfgFilePath Is Null Or Empty";
                IsInitOK = false;
                return false;
            }

            try
            {
                //_cfg = new JFXCfg();
                _cfg.Load(_cfgFilePath,true);
                LoadCfg(); //加载工站配置
            }
            catch(Exception ex)
            {
                _cfg = null;
                _initErrorInfo = "Load Station's cfg failed!path = " + _cfgFilePath + ",Error:" + ex.Message;
                IsInitOK = false;
                return false;
            }
            //处理在构造函数中声明的变量
            
            _initErrorInfo = "Success";
            IsInitOK = true;
            return true;
           

        }


        /// <summary>获取初始化状态，如果对象已初始化成功，返回True</summary>
        public virtual bool IsInitOK { get; private set; }

        /// <summary>获取初始化错误的描述信息</summary>
        public virtual string GetInitErrorInfo()
        {
            return _initErrorInfo;
        }
        #endregion


        #region 申明工站使用的不可删除对象（包括设备/配置/方法流） ， 建议（只）在继承类的构造函数中调用
        internal JFXmlDictionary<NamedChnType, List<List<string>>> DeclearedDevChnMapping
        { 
            get 
            {
                JFXmlDictionary<string, object> baseCfg = _cfg.GetItemValue("StationBasePrivateConfig") as JFXmlDictionary<string, object>;
                if (null == baseCfg)
                    return null;
                if (!baseCfg.ContainsKey("LocalDevChannelMap"))
                    return null;
                JFXmlDictionary<NamedChnType, List<List<string>>> dictDevChnMap = baseCfg["LocalDevChannelMap"] as JFXmlDictionary<NamedChnType, List<List<string>>>; //配置中已经保存的映射表
                return dictDevChnMap;
            }
        }



        JFXmlDictionary<NamedChnType, List<string>> _dictDeclearedDevChns = new JFXmlDictionary<NamedChnType, List<string>>();
        //Dictionary<string, string> _dictDeclearedDevChnMap = new Dictionary<string, string>(); //保存声明的本地名称和全局名称的映射
        /// <summary>
        /// 声明工站使用的设备/通道（名称）
        /// </summary>
        /// <param name="devType">设备类型</param>
        /// <param name="locName">设备在工站中的名称</param>
        /// <param name="globalName">设备全局名称</param>
        protected void DeclearDevChn(NamedChnType devType, string locName/*, string globalName = null*/)
        {
            if (devType == NamedChnType.None)
                throw new ArgumentException("DeclearDevChn(devType,...) failed by devType == NamedChnType.None");
            if (string.IsNullOrEmpty(locName))
                throw new ArgumentException("DeclearDevChn(devType,locName,...) failed by locName is null or empty");
            if (!_dictDeclearedDevChns.ContainsKey(devType))
                _dictDeclearedDevChns.Add(devType, new List<string>());
            if (_dictDeclearedDevChns[devType].Contains(locName))
                throw new ArgumentException("DeclearDevChn failed: locName = " + locName + " has been decleared!");
            _dictDeclearedDevChns[devType].Add(locName);
            //if(!string.IsNullOrEmpty(globalName))//注册时已指定设备的全局名
            //    _dictDeclearedDevChnMap.Add(locName, globalName);
            
        }

        /// <summary>
        /// 
        /// </summary>
        /// <param name="devType"></param>
        /// <param name="locName"></param>
        /// <returns></returns>
        public bool IsDevChnDecleared(NamedChnType devType, string locName)
        {
            if (!_dictDeclearedDevChns.ContainsKey(devType))
                return false;
            return _dictDeclearedDevChns[devType].Contains(locName);
        }



        List<string> _lstWorkPosDecleared = new List<string>();
        /// <summary>
        /// 声明一个工作点位
        /// </summary>
        /// <param name="wpName"></param>
        /// <param name="pos"></param>
        protected void DeclearWorkPosition(string wpName)
        {
            if (string.IsNullOrEmpty(wpName))
                throw new ArgumentNullException("DeclearWorkPosition(wpName) failed by: wpName is null or empty!");
            if (IsWorkPosDecleared(wpName))
                throw new ArgumentException("DeclearWorkPosition(wpName) failed by: wpName = " + wpName + " is already decleared");
            _lstWorkPosDecleared.Add(wpName);

        }


        public bool IsWorkPosDecleared(string wpName)
        {
            return _lstWorkPosDecleared.Contains(wpName);
        }


        List<string> _lstMethodFlowDecleared = new List<string>();

        /// <summary>
        /// 申明一个动作流（不可删除的）
        /// </summary>
        /// <param name="mfName"></param>
        /// <param name="mf"></param>
        protected void DeclearMethodFlow(string mfName)
        {
            if (string.IsNullOrEmpty(mfName))
                throw new ArgumentNullException("DeclearMethodFlow(string mfName) failed by: mfName is null or empty");
            if (IsMethodFlowDecleared(mfName))
                throw new Exception("DeclearMethodFlow(string mfName) failed by: mfName =" + mfName + " is already decleared!");
            _lstMethodFlowDecleared.Add(mfName);
        }

        public bool IsMethodFlowDecleared(string mfName)
        {
            return _lstMethodFlowDecleared.Contains(mfName);
        }

        



        #endregion


        bool IsRecievedEndBatchCmd { get; set; }
        /// <summary>
        /// IJFStation's API
        /// </summary>
        /// <returns></returns>
        public JFWorkCmdResult EndBatch(int milliSeconds = -1) // 向工作线程下达结批指令,供外部调用者使用
        {
            if (CurrWorkStatus != JFWorkStatus.Running)
                return JFWorkCmdResult.StatusError;
            IsRecievedEndBatchCmd = true;
            return JFWorkCmdResult.Success;
            //return _SendCmd(CommandEndBatch,)
        }
        

        /// <summary>
        /// 工作线程当前执行的任务模式
        /// </summary>
        enum _StationThreadWorkMode
        {
            Normal = 0,//正常工作模式
            Resetting, //工站归零任务
        }

        _StationThreadWorkMode _stationThreadWorkMode = _StationThreadWorkMode.Normal;

        public override JFWorkCmdResult Start()
        {
            lock (accessLocker)
            {
                if (_stationThreadWorkMode == _StationThreadWorkMode.Resetting) //当前正在进行归零动作
                {
                    if (CurrWorkStatus == JFWorkStatus.Running ||
                           CurrWorkStatus == JFWorkStatus.Pausing ||
                           CurrWorkStatus == JFWorkStatus.Interactiving
                           )
                        return JFWorkCmdResult.StatusError;
            }
                _stationThreadWorkMode = _StationThreadWorkMode.Normal;
                return base.Start();
            }
        }


        /// <summary>
        /// 向工站发送复位指令（各轴归零等动作）
        /// </summary>
        /// <returns></returns>
        public  JFWorkCmdResult Reset()
        {
            lock (accessLocker)
            {
                if (_stationThreadWorkMode == _StationThreadWorkMode.Normal)
                {
                    if (CurrWorkStatus == JFWorkStatus.Pausing ||
                        CurrWorkStatus == JFWorkStatus.Interactiving ||
                        CurrWorkStatus == JFWorkStatus.Pausing) // 正在运行时不能执行归零动作
                        return JFWorkCmdResult.StatusError;
                }
                _stationThreadWorkMode = _StationThreadWorkMode.Resetting; //将线程工作模式置为归零模式
                JFWorkCmdResult ret = base.Start();
                return ret;
            }
        }



        /// <summary>
        /// 执行归零动作，由继承类实现
        /// 函数如果执行失败 可通过ExitWork返回错误信息
        /// </summary>
        protected abstract void ExecuteReset();

        /// <summary>
        /// 打开程序后是否执行过一次归零动作
        /// </summary>
        bool _isExecuteResetOnce = false; 

        /// <summary>
        /// 执行结批动作，由继承类实现
        /// 函数如果执行失败 可通过ExitWork返回错误信息
        /// </summary>
        protected abstract void ExecuteEndBatch();





        /// <summary>
        /// 为了支持结批/归零动作，重写线程函数
        /// </summary>
        protected override void ThreadFunc()
        {
            long cmdWaited = CommandUnknown;
            WorkExitCode exitCode = WorkExitCode.Normal;
            try
            {
                cmdEvent.WaitOne();
                if (command != CommandStart)
                    ExitWork(WorkExitCode.Exception, "WorkThread receive first command is not CommandStart,command = " + command);
                RespCmd(JFWorkCmdResult.Success);
                ChangeWorkStatus(JFWorkStatus.Running);
                
                if(_stationThreadWorkMode == _StationThreadWorkMode.Normal)
                    PrepareWhenWorkStart();
                else
                {
                    SendMsg2Outter("工站开始执行归零...");
                    ExecuteReset();
                    _isExecuteResetOnce = true;
                    ExitWork(WorkExitCode.Normal, "工站归零执行完成");
                }


                string resetMode = GetCfgParamValue("工站归零模式") as string;
                if(resetMode == _resetModes[0]) //每次运行前都归零
                {
                    SendMsg2Outter("任务运行前开始归零...");
                    ExecuteReset();
                    SendMsg2Outter("归零完成，开始运行任务");
                    _isExecuteResetOnce = true;
                }
                else if(resetMode == _resetModes[1])//程序开启后只运行一次
                {
                    if(!_isExecuteResetOnce)
                    {
                        SendMsg2Outter("任务运行前开始归零...");
                        ExecuteReset();
                        SendMsg2Outter("归零完成，开始运行任务");
                        _isExecuteResetOnce = true;
                    }
                }


                while (true)
                {
                    CheckCmd(CycleMilliseconds < 0 ? -1 : CycleMilliseconds);
                    RunLoopInWork();
                    if(IsRecievedEndBatchCmd)
                    {
                        ExecuteEndBatch();//DllNotFoundException() hehe ...
                        IsRecievedEndBatchCmd = false;
                        ExitWork(WorkExitCode.Normal, "结批完成");
                    }
                }
            }
            catch (JFWorkExitException wee) //工作线程退出流程
            {
                //Monitor.Exit(workStatusLocker);
                exitCode = wee.ExitCode;
                SendMsg2Outter("任务即将退出:" + exitCode + " 信息:" + wee.ExitInfo);

            }
            catch (Exception ex)
            {
                exitCode = WorkExitCode.Exception;
                SendMsg2Outter("任务发生未知的程序异常:" + ex.Message);
                ChangeWorkStatus(JFWorkStatus.ExceptionExit);
            }
            finally
            {
                SendMsg2Outter("任务开始退出前清理");
                CleanupWhenWorkExit();
                SendMsg2Outter("任务清理完成，退出运行");
                switch (exitCode)
                {
                    case WorkExitCode.Command:
                        ChangeWorkStatus(JFWorkStatus.CommandExit);
                        break;
                    case WorkExitCode.Error:
                        ChangeWorkStatus(JFWorkStatus.ErrorExit);
                        break;
                    case WorkExitCode.Exception:
                        ChangeWorkStatus(JFWorkStatus.ExceptionExit);
                        break;
                    case WorkExitCode.Normal:
                        ChangeWorkStatus(JFWorkStatus.NormalEnd);
                        break;

                }
                _stationThreadWorkMode = _StationThreadWorkMode.Normal;
            }

        }


        #region IJFRealtimeUIProvider's API
        UcStationBaseRealtimeUI _ui = null;//new UcStationBaseRealtimeUI();
        public virtual JFRealtimeUI GetRealtimeUI()
        {
            return _ui;
        }
        #endregion

        #region IJFConfigUIProvider's API
        public virtual void ShowCfgDialog()
        {
            FormStationBaseCfg fm = new FormStationBaseCfg();
            fm.SetStation(this);
            fm.Text = "工站参数配置-" + Name;
            fm.ShowDialog();
        }

        public void Dispose()
        {
            try
            {
                if (Stop(1000) != JFWorkCmdResult.Success)
                    Abort();
            }
            catch
            {
                Abort();
            }
        }
        #endregion

        static object DefaultValueFromType(Type t)
        {
            if (t.IsValueType)
                return Activator.CreateInstance(t);
            
            //if (t == null)
            //    throw new ArgumentNullException("CreateInstance(Type t) failed By: t = null");
            //if (!typeof(IJFInitializable).IsAssignableFrom(t) || !t.IsClass || t.IsAbstract)
            //    throw new ArgumentException("CreateInstance(Type t) failed By: t is not an  entity class inherited from IJFInitializable");
            ConstructorInfo[] ctors = t.GetConstructors(System.Reflection.BindingFlags.Instance
                                                          | System.Reflection.BindingFlags.NonPublic
                                                          | System.Reflection.BindingFlags.Public);
            if (null == ctors)
                throw new Exception("CreateInstance(Type t) failed By: Not found t-Instance's Constructor");
            foreach (ConstructorInfo ctor in ctors)
            {
                ParameterInfo[] ps = ctor.GetParameters();
                if (ps == null || ps.Length == 0)
                    return ctor.Invoke(null) as IJFInitializable;
            }

            return null;
        }

        internal static bool IsNullableType(Type type)
        {
            return (type.IsGenericType && type.GetGenericTypeDefinition() == typeof(Nullable<>));
        }
        bool _isFirstLoadCfg = true;
        public virtual void LoadCfg()
        {
            _cfg.Load();
            if (!_cfg.ContainsItem("StationBasePrivateConfig"))
                _cfg.AddItem("StationBasePrivateConfig", new JFXmlDictionary<string,object>());
            JFXmlDictionary<string, object> baseCfg = _cfg.GetItemValue("StationBasePrivateConfig") as JFXmlDictionary<string, object>; //StationBase 专用配置

            if (!baseCfg.ContainsKey("DiNames"))
                baseCfg.Add("DiNames", new List<string>());//_cfg.AddItem("DiNames", new List<string>(), "BaseConfig");
            if (!baseCfg.ContainsKey("DoNames"))
                baseCfg.Add("DoNames", new List<string>());

            if (!baseCfg.ContainsKey("AiNames"))
                baseCfg.Add("AiNames", new List<string>());
            if (!baseCfg.ContainsKey("AoNames"))
                baseCfg.Add("AoNames", new List<string>());

            if (!baseCfg.ContainsKey("AxisNames"))
                baseCfg.Add("AxisNames", new List<string>());

            if (!baseCfg.ContainsKey("CmpTrigNames")) //比较触发器
                baseCfg.Add("CmpTrigNames", new List<string>());

            if (!baseCfg.ContainsKey("CameraNames"))
                baseCfg.Add("CameraNames", new List<string>());

            if (!baseCfg.ContainsKey("WorkPositions"))//工站的工作点位
                baseCfg.Add("WorkPositions", new List<JFMultiAxisPosition>());


            if (!baseCfg.ContainsKey("LightChannelNames"))//工站的光源通道名称
                baseCfg.Add("LightChannelNames", new List<string>());


            if (!baseCfg.ContainsKey("TrigChannelNames"))//工站的触发通道名称
                baseCfg.Add("TrigChannelNames", new List<string>());

            ///工站声明的设备通道名称与全局的设备通道名称的映射关系表
            if (!baseCfg.ContainsKey("LocalDevChannelMap"))
                baseCfg.Add("LocalDevChannelMap", new JFXmlDictionary<NamedChnType, List<List<string>>>());
            JFXmlDictionary<NamedChnType, List<List<string>>> dictDevChnMap = baseCfg["LocalDevChannelMap"] as JFXmlDictionary<NamedChnType, List<List<string>>>; //配置中已经保存的映射表
            AdjustDevChnMap(dictDevChnMap);
            _cfg.Save();










            _dictMethodFlow.Clear();
            if (!baseCfg.ContainsKey("MethodFlows"))//工站中包含的所有所有动作流的序列化文本
                baseCfg.Add("MethodFlows", new List<string>());
 
            List<string> methodFlowsTxts = baseCfg["MethodFlows"] as List<string>;
            foreach (string txt in methodFlowsTxts)
            {
                JFMethodFlow mf = new JFMethodFlow();
                mf.FromTxt(txt);
                _dictMethodFlow.Add(mf.Name,mf);
                mf.SetStation(this);
            }
            ///加载声明的方法流配置
            foreach(string mfDecleared in _lstMethodFlowDecleared)
            {
                bool isMFExisted = false;
                foreach(string mfName in _dictMethodFlow.Keys)
                    if(mfName == mfDecleared)
                    {
                        isMFExisted = true;
                        break;
                    }
                if(!isMFExisted)
                {
                    JFMethodFlow mf = new JFMethodFlow();
                    mf.Name = mfDecleared;
                    _dictMethodFlow.Add(mfDecleared,mf);
                    mf.SetStation(this);
                    _cfg.Save();
                }
            }


            ///加载继承类申明的配置项
            foreach (KeyValuePair<string,object[]> kv in dictCfgParamDecleared)
            {
                string cfgName = kv.Key;
                string cfgCategory = (kv.Value as object[])[0] as string;
                Type cfgType = (kv.Value[1] as JFParamDescribe).ParamType;
                object defaultValue = DefaultValueFromType(cfgType);
                if (!_cfg.ContainsItem(cfgName))
                {
                    _cfg.AddItem(cfgName, defaultValue, cfgCategory);
                    if (_isFirstLoadCfg && kv.Value.Length > 2) //用户在构造函数中改变了值
                        _cfg.SetItemValue(cfgName, kv.Value[2]);
                }
                else //cfg中已包含声明参数项 ，检查是否合法
                {
                    string currCategory = _cfg.GetItemTag(cfgName);
                    if(currCategory != cfgCategory) //检查类别名称是否合法
                    {
                        _cfg.RemoveItem(cfgName);
                        _cfg.AddItem(cfgName, defaultValue, cfgCategory);
                        if (_isFirstLoadCfg && kv.Value.Length > 2) //用户在构造函数中改变了值
                            _cfg.SetItemValue(cfgName, kv.Value[2]);
                    }
                    else //检查当前值类型是否合法
                    {
                        object currValue = _cfg.GetItemValue(cfgName);
                        if(null != currValue)
                        {
                            if(cfgType != currValue.GetType())
                            {
                                _cfg.RemoveItem(cfgName);
                                _cfg.AddItem(cfgName, defaultValue, cfgCategory);
                                if (_isFirstLoadCfg && kv.Value.Length > 2) //用户在构造函数中改变了值
                                    _cfg.SetItemValue(cfgName, kv.Value[2]);
                            }
                        }
                        else
                        {
                            if(!IsNullableType(cfgType))
                            {
                                _cfg.RemoveItem(cfgName);
                                _cfg.AddItem(cfgName, defaultValue, cfgCategory);
                                if (_isFirstLoadCfg && kv.Value.Length > 2) //用户在构造函数中改变了值
                                    _cfg.SetItemValue(cfgName, kv.Value[2]);
                            }
                        }
                    }
                }
            }

            ///加载声明的工作点位配置
            List<JFMultiAxisPosition> wokPosInCfg = baseCfg["WorkPositions"] as List<JFMultiAxisPosition>;
            foreach (string wpName in _lstWorkPosDecleared)
            {
                bool isExistedWP = false;
                foreach(JFMultiAxisPosition wp in wokPosInCfg)
                    if(wp.Name == wpName)
                    {
                        isExistedWP = true;
                        break;
                    }
                if (!isExistedWP)
                {
                    JFMultiAxisPosition ap = new JFMultiAxisPosition();
                    ap.Name = wpName;
                    wokPosInCfg.Add(ap);
                    _cfg.Save();
                }
            }

            


            _isFirstLoadCfg = false;
        }


        /// <summary>
        /// 整理注册的通道映射表 ，剔除多余的部分，增加（未加入的已声明通道）
        /// </summary>
        /// <param name="devChnMapInCfg">已保存在配置文件中的映射表</param>
        void AdjustDevChnMap(JFXmlDictionary<NamedChnType, List<List<string>>> devChnMapInCfg)
        {
            if (_dictDeclearedDevChns.Keys.Count == 0)
            {
                devChnMapInCfg.Clear();
                return;
            }

            //先删除配置中多余的Key
            int keyCount = devChnMapInCfg.Keys.Count;
            while(keyCount > 0)
            {
                int index = 0;
                foreach (NamedChnType k in devChnMapInCfg.Keys)
                {
                    if (!_dictDeclearedDevChns.Keys.Contains(k))
                    {
                        devChnMapInCfg.Remove(k);
                        break;
                    }
                    else
                        index++;
                }
                if (keyCount == index)
                    break;
                keyCount = devChnMapInCfg.Keys.Count;
            }


            foreach (NamedChnType k in _dictDeclearedDevChns.Keys)
            {
                if (!devChnMapInCfg.ContainsKey(k))
                {
                    devChnMapInCfg.Add(k, new List<List<string>>());
                    List<string> devChnDecleared = _dictDeclearedDevChns[k];
                    foreach (string locDevChnName in devChnDecleared)
                    {
                        List<string> locAndGlobName = new List<string>();
                        locAndGlobName.Add(locDevChnName);
                        locAndGlobName.Add("");
                        devChnMapInCfg[k].Add(locAndGlobName);
                    }
                }
                else
                {
                    List<string> devChnDecleared = _dictDeclearedDevChns[k];
                    List<List<string>> devChnMap = devChnMapInCfg[k];

                    ///先删除多余的部分
                    int dcCount = devChnMap.Count;
                    while (dcCount > 0)
                    {
                        int index = 0;
                        foreach (List<string> dcm in devChnMap)
                        {
                            if (!devChnDecleared.Contains(dcm[0]))
                            {
                                devChnMap.Remove(dcm);
                                break;
                            }
                            else
                                index++;
                        }
                        if (index == dcCount)
                            break;
                        dcCount = devChnMap.Count;
                    }


                    //再添加缺少的部分
                    foreach (string locDevChnName in devChnDecleared) 
                    {
                        bool isFound = false;
                        foreach(List<string> kv in devChnMap)
                            if(kv[0] == locDevChnName)
                            {
                                isFound = true;
                                break;
                            }
                        if (!isFound)
                        {
                            List<string> locAndGlobNames = new List<string>();
                            locAndGlobNames.Add(locDevChnName);
                            locAndGlobNames.Add("");
                            devChnMap.Add(locAndGlobNames);
                        }

                    }

                   



                }

            }

        }

        public virtual void SaveCfg()
        {
            List<string> methodFlowTxts = new List<string>();
            foreach (JFMethodFlow mf in _dictMethodFlow.Values)
                methodFlowTxts.Add(mf.ToTxt());
            (_cfg.GetItemValue("StationBasePrivateConfig") as JFXmlDictionary<string,object>)["MethodFlows"]= methodFlowTxts;
            _cfg.Save();
        }

        List<string> _SBCfg(string sbCfgName)// => (_cfg.GetItemValue("StationBasePrivateConfig") as JFXmlDictionary<string, object>)[sbCfgName] as List<string>;
        {
            if (null == _cfg)
                return new List<string>();
            if(!_cfg.ContainsItem("StationBasePrivateConfig")) //if (null == _cfg.GetItemValue("StationBasePrivateConfig"))
                return new List<string>();
            JFXmlDictionary<string, object> cfgItm = _cfg.GetItemValue("StationBasePrivateConfig") as JFXmlDictionary<string, object>;
            if (!cfgItm.ContainsKey(sbCfgName))
                return new List<string>();
            return cfgItm[sbCfgName] as List<string>;
           // return (_cfg.GetItemValue("StationBasePrivateConfig") as JFXmlDictionary<string, object>)[sbCfgName] as List<string>;
        }

        /// <summary>
        ///  获取工站所用的数字量输入（通道）
        /// </summary>
        public string[] DINames 
        {
            get
            {
                return _SBCfg("DiNames").ToArray();
            }
        }

        public void AddDI(string diName)
        {
            if (string.IsNullOrEmpty(diName))
                throw new ArgumentNullException("AddDi(diName) failed by:diName is null or empty");
            List<string> diNames = _SBCfg("DiNames");//_cfg.GetItemValue("DiNames") as List<string>;
            if (diNames.Contains(diName))
                return;
            diNames.Add(diName);
        }

        public void RemoveDI(string diName)
        {
            List<string> diNames = _SBCfg("DiNames");//_cfg.GetItemValue("DiNames") as List<string>;
            if (!diNames.Contains(diName))
                return;
            diNames.Remove(diName);
        }

        public void ClearDI()
        {
            _SBCfg("DiNames").Clear();//(_cfg.GetItemValue("DiNames") as List<string>).Clear();
        }

        public string[] DONames
        {
            get
            {
                return _SBCfg("DoNames").ToArray();//(_cfg.GetItemValue("DoNames") as List<string>).ToArray();
            }
        }

        public void AddDO(string doName)
        {
            if (string.IsNullOrEmpty(doName))
                throw new ArgumentNullException("AddDo(doName) failed by:doName is null or empty");
            List<string> doNames = _SBCfg("DoNames");//_cfg.GetItemValue("DoNames") as List<string>;
            if (doNames.Contains(doName))
                return;
            doNames.Add(doName);
        }

        public void RemoveDO(string doName)
        {
            List<string> doNames = _SBCfg("DoNames");//_cfg.GetItemValue("DoNames") as List<string>;
            if (!doNames.Contains(doName))
                return;
            doNames.Remove(doName);
        }

        public void ClearDO()
        {
            _SBCfg("DoNames").Clear();
        }


        public string[] AINames
        {
            get
            {
                return _SBCfg("AiNames").ToArray();//(_cfg.GetItemValue("AiNames") as List<string>).ToArray();
            }
        }

        public void AddAI(string aiName)
        {
            if (string.IsNullOrEmpty(aiName))
                throw new ArgumentNullException("AddAi(aiName) failed by:aiName is null or empty");
            List<string> aiNames = _SBCfg("AiNames");//_cfg.GetItemValue("AiNames") as List<string>;
            if (aiNames.Contains(aiName))
                return;
            aiNames.Add(aiName);
        }

        public void RemoveAI(string aiName)
        {
            List<string> aiNames = _SBCfg("AiNames");//_cfg.GetItemValue("AiNames") as List<string>;
            if (!aiNames.Contains(aiName))
                return;
            aiNames.Remove(aiName);
        }

        public void ClearAI()
        {
            _SBCfg("AiNames").Clear();
        }



        public string[] AONames
        {
            get
            {
                return _SBCfg("AoNames").ToArray();//(_cfg.GetItemValue("AoNames") as List<string>).ToArray();
            }
        }

        public void AddAO(string aoName)
        {
            if (string.IsNullOrEmpty(aoName))
                throw new ArgumentNullException("AddAo(aoName) failed by:aoName is null or empty");
            List<string> aoNames = _SBCfg("AoNames");//_cfg.GetItemValue("AoNames") as List<string>;
            if (aoNames.Contains(aoName))
                return;
            aoNames.Add(aoName);
        }

        public void RemoveAO(string aoName)
        {
            List<string> aoNames = _SBCfg("AoNames");//_cfg.GetItemValue("AoNames") as List<string>;
            if (!aoNames.Contains(aoName))
                return;
            aoNames.Remove(aoName);
        }

        public void ClearAO()
        {
            _SBCfg("AoNames").Clear();//(_cfg.GetItemValue("AoNames") as List<string>).Clear();
        }


        public string[] AxisNames
        {
            get
            {
                return _SBCfg("AxisNames").ToArray();//(_cfg.GetItemValue("AxisNames") as List<string>).ToArray();
            }
        }

        public void AddAxis(string axisName)
        {
            if (string.IsNullOrEmpty(axisName))
                throw new ArgumentNullException("AddAxis(axisName) failed by:axisName is null or empty");
            List<string> axisNames = _SBCfg("AxisNames");//_cfg.GetItemValue("AxisNames") as List<string>;
            if (axisNames.Contains(axisName))
                return;
            axisNames.Add(axisName);
        }

        public void RemoveAxis(string axisName)
        {
            List<string> axisNames = _SBCfg("AxisNames");//_cfg.GetItemValue("AxisNames") as List<string>;
            if (!axisNames.Contains(axisName))
                return;
            axisNames.Remove(axisName);
        }

        public void ClearAxis()
        {
            _SBCfg("AxisNames").Clear();//(_cfg.GetItemValue("AxisNames") as List<string>).Clear();
        }

        public bool ContainAxis(string axisName)
        {
            return _SBCfg("AxisNames").Contains(axisName);//return (_cfg.GetItemValue("AxisNames") as List<string>).Contains(axisName);
        }
             


        public string[] CmpTrigNames
        {
            get
            {
                return _SBCfg("CmpTrigNames").ToArray();//(_cfg.GetItemValue("CmpTrigNames") as List<string>).ToArray();
            }
        }

        public void AddCmpTrig(string cmpTrigName)
        {
            if (string.IsNullOrEmpty(cmpTrigName))
                throw new ArgumentNullException("AddCmpTrig(cmpTrigName) failed by:cmpTrigName is null or empty");
            List<string> cmpTrigNames = _SBCfg("CmpTrigNames");//_cfg.GetItemValue("CmpTrigNames") as List<string>;
            if (cmpTrigNames.Contains(cmpTrigName))
                return;
            cmpTrigNames.Add(cmpTrigName);
        }

        public void RemoveCmpTrig(string cmpTrigName)
        {
            List<string> cmpTrigNames = _SBCfg("CmpTrigNames");//_cfg.GetItemValue("CmpTrigNames") as List<string>;
            if (!cmpTrigNames.Contains(cmpTrigName))
                return;
            cmpTrigNames.Remove(cmpTrigName);
        }

        public void ClearCmpTrig()
        {
            _SBCfg("CmpTrigNames").Clear();//(_cfg.GetItemValue("CmpTrigNames") as List<string>).Clear();
        }


        public string[] CameraNames
        {
            get
            {
                return _SBCfg("CameraNames").ToArray();//(_cfg.GetItemValue("CameraNames") as List<string>).ToArray();
            }
        }

        public void AddCamera(string cmrName)
        {
            if (string.IsNullOrEmpty(cmrName))
                throw new ArgumentNullException("AddCamera(cmrName) failed by:cmrName is null or empty");
            List<string> cmrNames = _SBCfg("CameraNames");//_cfg.GetItemValue("CameraNames") as List<string>;
            if (cmrNames.Contains(cmrName))
                return;
            cmrNames.Add(cmrName);
        }

        public void RemoveCamera(string cmrName)
        {
            List<string> cmrNames = _SBCfg("CameraNames");//_cfg.GetItemValue("CameraNames") as List<string>;
            if (!cmrNames.Contains(cmrName))
                return;
            cmrNames.Remove(cmrName);
        }

        public void ClearCamera()
        {
            _SBCfg("CameraNames").Clear();//(_cfg.GetItemValue("CameraNames") as List<string>).Clear();
        }

        public string[] WorkPositionNames
        {
            get
            {
                List<string> ret = new List<string>();
                List<JFMultiAxisPosition> allPos = WorkPositions;
                foreach (JFMultiAxisPosition pos in allPos)
                    ret.Add(pos.Name);
                return ret.ToArray();
            }
        }

        public bool ContianPositionName(string posName)
        {
            foreach (JFMultiAxisPosition pos in WorkPositions)
                if (pos.Name == posName)
                    return true;
            return false;
        }

        public JFMultiAxisPosition GetWorkPosition(string name)
        {
            List<JFMultiAxisPosition> allPos = WorkPositions;
            foreach (JFMultiAxisPosition pos in allPos)
                if (pos.Name == name)
                    return pos;
            return null;
        }

        public void AddWorkPosition(JFMultiAxisPosition maPos)
        {
            if (null == maPos || string.IsNullOrEmpty(maPos.Name))
                throw new ArgumentNullException("SetWorkPosition(maPos) failed by:maPos == null or maPos.Name is null or empty");
            List<JFMultiAxisPosition> allPos = WorkPositions;
            for(int i = 0; i < allPos.Count;i++)
                if (allPos[i].Name == maPos.Name)
                {
                    allPos[i] = maPos;
                    return;
                }
            allPos.Add(maPos);
        }

        /// <summary>
        /// 移除工作点位
        /// </summary>
        /// <param name="name"></param>
        public void RemoveWorkPosition(string name)
        {
            if (string.IsNullOrEmpty(name))
                return;
            List<JFMultiAxisPosition> allPos = WorkPositions;
            for (int i = 0; i < allPos.Count; i++)
                if (allPos[i].Name == name)
                {
                    allPos.RemoveAt(i);
                    return ;
                }
        }

        /// <summary>
        /// 移动到工作点位posName （非插补模式）
        /// </summary>
        /// <param name="posName"></param>
        /// <param name="errorInfo"></param>
        /// <returns></returns>
        public bool MoveToWorkPosition(string posName,out string errorInfo)
        {
            errorInfo = "Success";
            string[] workPosNames = WorkPositionNames;
            if (WorkPositionNames == null)
            {
                errorInfo = "无工作点位Name = " + posName;
                return false;
            }
            bool isExisted = false;
            foreach(string workPosName in workPosNames)
                if(workPosName == posName)
                {
                    isExisted = true;
                    break;
                }
            if(!isExisted)
            {
                errorInfo = " 工作点位Name = \"" + posName + "\"不存在";
                return false;
            }

            JFMultiAxisPosition pos = GetWorkPosition(posName);
            return MoveToPosition(pos, out errorInfo);

        }

        /// <summary>
        /// 检查轴通道(设备)是否存在(可用)
        /// </summary>
        /// <param name="axisName"></param>
        /// <returns></returns>
        JFDevCellInfo CheckAxisDevInfo(string axisName,out string errorInfo)
        {
            if (!ContainAxis(axisName))
            {
                errorInfo = "工站不包含轴，Name = \"" + axisName + "\"";
                return null;
            }
            JFDevCellInfo ci = JFHubCenter.Instance.MDCellNameMgr.GetAxisCellInfo(axisName); //在命名表中的通道信息
            if (null == ci)
            {
                errorInfo = "未找到轴:\"" + axisName + "\"设备信息";
                return null;
            }
            IJFDevice_MotionDaq dev = JFHubCenter.Instance.InitorManager.GetInitor(ci.DeviceID) as IJFDevice_MotionDaq;
            if (null == dev)
            {
                errorInfo = "未找到轴:\"" + axisName + "\"所属设备:\"" + ci.DeviceID + "\"";
                return null;
            }
            if (!dev.IsDeviceOpen)
            {
                errorInfo = "轴:\"" + axisName + "\"所属设备:\"" + ci.DeviceID + "\"未打开";
                return null;
            }
            if (ci.ModuleIndex >= dev.McCount)
            {
                errorInfo = "轴:\"" + axisName + "\"模块序号:\"" + ci.ModuleIndex + "\"超出限制!";
                return null;
            }
            IJFModule_Motion md = dev.GetMc(ci.ModuleIndex);
            if (ci.ChannelIndex >= md.AxisCount)
            {
                errorInfo = "轴:\"" + axisName + "\"通道序号:\"" + ci.ChannelIndex + "\"超出限制!";
                return null;
            }

            errorInfo = "";
            return ci;
        }

        bool CheckAxisCanMove(string axisName, out string errorInfo)
        {
            JFDevCellInfo ci = CheckAxisDevInfo(axisName, out errorInfo);
            if (null == ci)
                return false;
            
            IJFModule_Motion md = (JFHubCenter.Instance.InitorManager.GetInitor(ci.DeviceID) as IJFDevice_MotionDaq).GetMc(ci.ModuleIndex);
            return CheckAxisCanMove(md, ci.ChannelIndex, out errorInfo);
        }

        public bool AxisServo(string axisName,bool isServOn,out string errorInfo)
        {
            JFDevCellInfo ci = CheckAxisDevInfo(axisName, out errorInfo);
            if (null == ci)
            {
                errorInfo = "轴:\"" + axisName + "\"伺服" + (isServOn ? "使能" : "去使能") + "失败,ErrorInfo:" + errorInfo;
                return false;
            }
            int errCode = 0;
            if (isServOn)
                errCode = (JFHubCenter.Instance.InitorManager.GetInitor(ci.DeviceID) as IJFDevice_MotionDaq).GetMc(ci.ModuleIndex).ServoOn(ci.ChannelIndex);
            else
                errCode = (JFHubCenter.Instance.InitorManager.GetInitor(ci.DeviceID) as IJFDevice_MotionDaq).GetMc(ci.ModuleIndex).ServoOff(ci.ChannelIndex);
            if(errCode != 0)
            {
                errorInfo = "轴:\"" + axisName + "\"伺服" + (isServOn ? "使能" : "去使能") + "失败,ErrorInfo:" + (JFHubCenter.Instance.InitorManager.GetInitor(ci.DeviceID) as IJFDevice_MotionDaq).GetMc(ci.ModuleIndex).GetErrorInfo(errCode);
                return false;
            }
            errorInfo = "Success";
            return true;
        }

        //public bool AllAxisServo(bool isServOn, out string errorInfo)
        //{
        //    errorInfo = "Success";
        //    string[] axisNames = AxisNames;
        //    if (null == axisNames || 0 == axisNames.Length)
        //        return true;
        //    foreach(string axis)
        //}

        bool CheckAxisCanMove(IJFModule_Motion md ,int axisIndex,out string errorInfo)
        {
            bool[] axisStatus;
            int errRet = md.GetMotionStatus(axisIndex, out axisStatus);
            if (0 != errRet)
            {
                errorInfo = "获取轴状态失败";
                               return false;
            }
            if (!axisStatus[md.MSID_SVO])
            {
                errorInfo = "轴伺服未使能";
                                return false;
            }
            if (axisStatus[md.MSID_ALM])
            {
                errorInfo = "轴已报警";
                return false;
            }
            
            ////////////////////////////////////////////
            ///景焱控制卡在轴到达限位停止后，即使停了也不会反馈MDN或INP信号
            //if (!axisStatus[md.MSID_MDN])
            //{
            //    errorInfo = "轴运动未完成";
            //    return false;
            //}

            //if (!axisStatus[md.MSID_INP])
            //{
            //    errorInfo = "轴运动未到位";
            //    return false;
            //}

            errorInfo = "";
            return true;
        }

        public bool MoveToPosition(JFMultiAxisPosition pos, out string errorInfo)
        {
            errorInfo = "Success";
            string[] axisNamesInPos = pos.AxisNames;
            if (null == axisNamesInPos || 0 == axisNamesInPos.Length)
            {
                errorInfo = "点位中不包含轴/电机";
                return false;
            }
            
            string[] AxisNamesInStation = AxisNames;
            if(AxisNamesInStation == null || AxisNamesInStation.Length == 0)
            {
                errorInfo = "工站配置中没有轴/电机";
                return false;
            }
            List<JFDevCellInfo> lstAxisCIs = new List<JFDevCellInfo>();
            foreach(string axisNameInPos in axisNamesInPos)
            {
                JFDevCellInfo ci = CheckAxisDevInfo(axisNameInPos, out errorInfo);
                if (null == ci)
                {
                    errorInfo = errorInfo = "轴移动失败 Name = \"" + axisNameInPos + "\",ErrorInfo :" + errorInfo;
                    return false;
                }
                lstAxisCIs.Add(ci);
            }

            bool isAllAxisOK = true;
            int i = 0;
            for(i = 0; i < lstAxisCIs.Count;i++)
            {
                IJFModule_Motion md = (JFHubCenter.Instance.InitorManager.GetInitor(lstAxisCIs[i].DeviceID) as IJFDevice_MotionDaq).GetMc(lstAxisCIs[i].ModuleIndex);
                if(!CheckAxisCanMove(md, lstAxisCIs[i].ChannelIndex,out errorInfo))
                {
                    errorInfo = "轴移动失败 Name = \"" + axisNamesInPos[i] + "\",ErrorInfo :" + errorInfo;
                    isAllAxisOK = false;
                    break;
                }
              
                int errCode =md.AbsMove(lstAxisCIs[i].ChannelIndex, pos.GetAxisPos(axisNamesInPos[i]));
                if (0 != errCode)
                {
                    errorInfo = "轴移动失败 Name = \"" + axisNamesInPos[i] + "\",ErrorInfo :" + md.GetErrorInfo(errCode);
                    isAllAxisOK = false;
                    break;
                }
            }
            if(!isAllAxisOK)
            {
                for (int j = 0; j < i; j++)
                    (JFHubCenter.Instance.InitorManager.GetInitor(lstAxisCIs[j].DeviceID) as IJFDevice_MotionDaq).GetMc(lstAxisCIs[j].ModuleIndex).StopAxis(lstAxisCIs[j].ChannelIndex);
                return false;
            }
            return true;
            
        }

        

        public bool WaitMotionDone(string axisName,int milliSenconds = -1)
        {
            string errorInfo = "";
            JFDevCellInfo ci = CheckAxisDevInfo(axisName, out errorInfo);
            if (null == ci)
                return false;

            DateTime startTime = DateTime.Now;
            IJFModule_Motion md = (JFHubCenter.Instance.InitorManager.GetInitor(ci.DeviceID) as IJFDevice_MotionDaq).GetMc(ci.ModuleIndex);
            while (true)
            {
                if(md.IsMDN(ci.ChannelIndex))
                {
                    errorInfo = "Success";
                    return true;
                }
                if(IsInWorkThread())
                    CheckCmd(CycleMilliseconds);
                if (milliSenconds >= 0)
                {
                    TimeSpan ts = DateTime.Now - startTime;
                    if (milliSenconds >= 0 && ts.TotalMilliseconds >= milliSenconds)
                        return false;
                }
                
            }


        }

        public bool LineToWorkPosition(string posName, out string errorInfo)
        {
            if (WorkPositionNames == null)
            {
                errorInfo = "无工作点位Name = " + posName;
                return false;
            }
            string[] workPosNames = WorkPositionNames;
            bool isExisted = false;
            foreach (string workPosName in workPosNames)
                if (workPosName == posName)
                {
                    isExisted = true;
                    break;
                }
            if (!isExisted)
            {
                errorInfo = " 工作点位Name = \"" + posName + "\"不存在";
                return false;
            }

            JFMultiAxisPosition pos = GetWorkPosition(posName);
            return LineToPosition(pos, out errorInfo);
        }

        /// <summary>
        /// 直线插补到某一个点位
        /// </summary>
        /// <param name="pos"></param>
        /// <param name="errorInfo"></param>
        /// <returns></returns>
        public bool LineToPosition(JFMultiAxisPosition pos, out string errorInfo)
        {
            errorInfo = "Success";
            string[] axisNamesInPos = pos.AxisNames;
            if (null == axisNamesInPos || 0 == axisNamesInPos.Length)
            {
                errorInfo = "点位中不包含轴/电机";
                return false;
            }
            string[] AxisNamesInStation = AxisNames;
            if (AxisNamesInStation == null || AxisNamesInStation.Length == 0)
            {
                errorInfo = "工站配置中没有轴/电机";
                return false;
            }
            List<JFDevCellInfo> lstAxisCIs = new List<JFDevCellInfo>();
            foreach (string axisNameInPos in axisNamesInPos)
            {
                JFDevCellInfo ci = CheckAxisDevInfo(axisNameInPos, out errorInfo);
                if (null == ci)
                {
                     errorInfo = "轴移动失败 Name = \"" + axisNameInPos + "\",ErrorInfo :" + errorInfo;
                    return false;
                }
                if(0 == lstAxisCIs.Count)
                    lstAxisCIs.Add(ci);
                else
                {
                    foreach(JFDevCellInfo ciExist in lstAxisCIs)
                        if(ciExist.DeviceID != ci.DeviceID || ciExist.ModuleIndex != ci.ModuleIndex)
                        {
                            errorInfo = "插补运动失败 Name = \"" + axisNameInPos + "\",与其他轴不在一个设备/模块中"; 
                            return false;
                        }
                    lstAxisCIs.Add(ci);
                }
                if(!CheckAxisCanMove(axisNameInPos,out errorInfo))
                {
                    errorInfo = "插补运动失败 轴名 = \"" + axisNameInPos + "\" ErrorInfo:" + errorInfo;
                    return false;
                }
            }
            List<int> axisIndexes = new List<int>();
            List<double> axisPoses = new List<double>();
            for(int i = 0; i < pos.Positions.Count;i++)
            {
                axisIndexes.Add(lstAxisCIs[i].ChannelIndex);
                axisPoses.Add(pos.Positions[i].Position);
            }
            int errCode = (JFHubCenter.Instance.InitorManager.GetInitor(lstAxisCIs[0].DeviceID) as IJFDevice_MotionDaq).GetMc(lstAxisCIs[0].ModuleIndex).AbsLine(axisIndexes.ToArray(), axisPoses.ToArray());
            if(errCode != 0)
            {
                errorInfo = "轴插补失败，ErrorInfo:" + (JFHubCenter.Instance.InitorManager.GetInitor(lstAxisCIs[0].DeviceID) as IJFDevice_MotionDaq).GetMc(lstAxisCIs[0].ModuleIndex).GetErrorInfo(errCode);
                return false;
            }
            return true;

        }


        /// <summary>
        /// 单轴运动(PTP)
        /// </summary>
        /// <param name="axisName"></param>
        /// <param name="pos"></param>
        /// <param name=""></param>
        /// <returns></returns>
        public bool MoveAxis(string axisName,double pos,bool isAbs,out string errorInfo)
        {
            errorInfo = "Success";
            JFDevCellInfo ci = CheckAxisDevInfo(axisName, out errorInfo);
            if(null == ci)
            {
                errorInfo = "轴移动失败，Name = \"" + axisName + "\",ErrorInfo:" + errorInfo;
                return false;
            }

            if(!CheckAxisCanMove(axisName,out errorInfo))
            {
                errorInfo = "轴移动失败，Name = \"" + axisName + "\",ErrorInfo:" + errorInfo;
                return false;
            }
            int errCode = 0;
            if (isAbs)
                errCode = (JFHubCenter.Instance.InitorManager.GetInitor(ci.DeviceID) as IJFDevice_MotionDaq).GetMc(ci.ModuleIndex).AbsMove(ci.ChannelIndex, pos);
            else
                errCode = (JFHubCenter.Instance.InitorManager.GetInitor(ci.DeviceID) as IJFDevice_MotionDaq).GetMc(ci.ModuleIndex).RelMove(ci.ChannelIndex, pos);

            if (errCode != 0)
            {
                errorInfo = "轴移动失败，Name = \"" + axisName + "\",ErrorInfo:" + (JFHubCenter.Instance.InitorManager.GetInitor(ci.DeviceID) as IJFDevice_MotionDaq).GetMc(ci.ModuleIndex).GetErrorInfo(errCode);
                return false;
            }
            return true;
        }


        public List<JFMultiAxisPosition> WorkPositions { get { return (_cfg.GetItemValue("StationBasePrivateConfig") as JFXmlDictionary<string,object>)["WorkPositions"] as List<JFMultiAxisPosition>; } }
        
        public string[] WorkFlowNames
        {
            get
            {
                return _dictMethodFlow.Keys.ToArray();
            }
        }

        
        public bool ContainWorkFlow(string wfName)
        {
            return _dictMethodFlow.ContainsKey(wfName);
        }

        public JFMethodFlow GetWorkFlow(string mfName)
        {
            if (!_dictMethodFlow.ContainsKey(mfName))
                return null;
            return _dictMethodFlow[mfName];
        }

        public bool AddWorkFlow(JFMethodFlow mf)
        {
            if (null == mf)
                return false;
            if (_dictMethodFlow.ContainsKey(mf.Name))
                return false;
            if (_dictMethodFlow.ContainsValue(mf))
                return false;

            _dictMethodFlow.Add(mf.Name, mf);
            mf.SetStation(this);
            return true;
        }

        public void RemoveWorkFlow(string mfName)
        {
            if (!_dictMethodFlow.ContainsKey(mfName))
                return;
            if(_dictMethodFlowBoxes.ContainsKey(mfName)) //方法已经被包装在容器中（可能正在运行）
            {
                _dictMethodFlowBoxes[mfName].Stop();
                _dictMethodFlowBoxes.Remove(mfName);
            }
            _dictMethodFlow.Remove(mfName);
            return;
        }



        /// <summary>
        /// 获取轴(电机)当前的实际位置
        /// </summary>
        public bool GetAxisPosition(string axisName,out double dPos,out string errorInfo)
        {
            dPos = 0;
            errorInfo = "Unknown-Error";
            JFDevCellInfo axisCellInfo = JFHubCenter.Instance.MDCellNameMgr.GetAxisCellInfo(axisName);
            if(null == axisCellInfo)
            {
                errorInfo = string.Format("轴名称:\"{0}\"在配置表中不存在！", axisName);
                return false;
            }

            if(!JFHubCenter.Instance.InitorManager.ContainID(axisCellInfo.DeviceID))
            {
                errorInfo = string.Format("轴:\"{0}\"所属设备\"{1}\"在设备管理器中不存在!", axisName, axisCellInfo.DeviceID);
            }
            IJFDevice_MotionDaq dev = JFHubCenter.Instance.InitorManager.GetInitor(axisCellInfo.DeviceID) as IJFDevice_MotionDaq;
            if(!dev.IsDeviceOpen)
            {
                errorInfo = string.Format("轴:\"{0}\"所属设备\"{1}\"未打开!", axisName, axisCellInfo.DeviceID);
                return false;
            }
            if(axisCellInfo.ModuleIndex >= dev.McCount)
            {
                errorInfo = string.Format("轴:\"{0}\"所属模块序号\"{1}超出限制:0~{2}\"", axisName, axisCellInfo.ModuleIndex, dev.McCount-1);
                return false;
            }

            IJFModule_Motion motion = dev.GetMc(axisCellInfo.ModuleIndex);
            if(axisCellInfo.ChannelIndex >= motion.AxisCount)
            {
                errorInfo = string.Format("轴:\"{0}\"通道序号\"{1}超出限制:0~{2}\"", axisName, axisCellInfo.ChannelIndex, motion.AxisCount - 1);
                return false;
            }

            int errorCode = motion.GetFbkPos(axisCellInfo.ChannelIndex, out dPos);
            if (0 == errorCode)
            {
                errorInfo = "Success";
                return true;
            }

            errorInfo = string.Format("获取轴:\"{0}\"位置失败：ErrorInfo:{1}", axisName, motion.GetErrorInfo(errorCode));
            return false;
        }


        //public abstract string[] InternalMethodFlowNames();

        //FormStationBase _stationForm = new FormStationBase();

        /// <summary>
        /// 用于单独调试工站的窗口界面(不建议以Dialog模式显示)
        /// </summary>
        /// <returns></returns>
        public virtual Form GenForm()
        {
            //get 
            {
                //_stationForm.SetStation(this); 
                //return _stationForm; 
                FormStationBaseDebug fm = new FormStationBaseDebug();
                fm.SetStation(this);
                return fm;
            }
        }

        /// <summary>
        /// 工站包含的所有光源通道名称
        /// </summary>
        public string[] LightChannelNames 
        { 
            get
            {
                return _SBCfg("LightChannelNames").ToArray();//return (_cfg.GetItemValue("LightChannelNames") as List<string>).ToArray();
            }
        }

        public void AddLightChannel(string chnName)
        {
            if (string.IsNullOrEmpty(chnName))
                throw new ArgumentNullException("AddLightChannel(chnName) failed by:chnName is null or empty");
            List<string> chnNames = _SBCfg("LightChannelNames");//_cfg.GetItemValue("LightChannelNames") as List<string>;
            if (chnNames.Contains(chnName))
                return;
            chnNames.Add(chnName);
        }

        public void RemoveLightChannel(string chnName)
        {
            List<string> chnNames = _SBCfg("LightChannelNames");//_cfg.GetItemValue("LightChannelNames") as List<string>;
            if (!chnNames.Contains(chnName))
                return;
            chnNames.Remove(chnName);
        }

        public void ClearLightChannel()
        {
            _SBCfg("LightChannelNames").Clear();//(_cfg.GetItemValue("LightChannelNames") as List<string>).Clear();
        }



        public string[] TrigChannelNames
        {
            get
            {
                return _SBCfg("TrigChannelNames").ToArray();//return (_cfg.GetItemValue("TrigChannelNames") as List<string>).ToArray();
            }
        }

        public void AddTrigChannel(string chnName)
        {
            if (string.IsNullOrEmpty(chnName))
                throw new ArgumentNullException("AddTrigChannel(chnName) failed by:chnName is null or empty");
            List<string> chnNames = _SBCfg("TrigChannelNames");//_cfg.GetItemValue("TrigChannelNames") as List<string>;
            if (chnNames.Contains(chnName))
                return;
            chnNames.Add(chnName);
        }

        public void RemoveTrigChannel(string chnName)
        {
            List<string> chnNames = _SBCfg("TrigChannelNames");//_cfg.GetItemValue("TrigChannelNames") as List<string>;
            if (!chnNames.Contains(chnName))
                return;
            chnNames.Remove(chnName);
        }

        public void ClearTrigChannel()
        {
            _SBCfg("TrigChannelNames").Clear();//(_cfg.GetItemValue("TrigChannelNames") as List<string>).Clear();
        }

        /*
        public IJFInitializable CreateInstance(Type t)
        {
            if (t == null)
                throw new ArgumentNullException("CreateInstance(Type t) failed By: t = null");
            if (!typeof(IJFInitializable).IsAssignableFrom(t) || !t.IsClass || t.IsAbstract)
                throw new ArgumentException("CreateInstance(Type t) failed By: t is not an  entity class inherited from IJFInitializable");
            ConstructorInfo[] ctors = t.GetConstructors(System.Reflection.BindingFlags.Instance
                                                          | System.Reflection.BindingFlags.NonPublic
                                                          | System.Reflection.BindingFlags.Public);
            if (null == ctors)
                throw new Exception("CreateInstance(Type t) failed By: Not found t-Instance's Constructor");
            foreach (ConstructorInfo ctor in ctors)
            {
                ParameterInfo[] ps = ctor.GetParameters();
                if (ps == null || ps.Length == 0)
                    return ctor.Invoke(null) as IJFInitializable;
            }

            return null;
        }
        */


        /// <summary>
        /// 存放继承类中声明的参数配置 ， 
        /// Key = ItemName
        /// Value = <"参数类别",参数类型> 
        /// </summary>
        Dictionary<string, object[]> dictCfgParamDecleared = new Dictionary<string, object[]>(); 
        /// <summary>
        /// 供继承类申明需要的序列化参数
        /// 只在继承类的构造函数中使用
        /// </summary>
        /// <param name="paramName"></param>
        /// <param name="paramType"></param>
        public void DeclearCfgParam(string cfgName,Type cfgType,string category = "StationConfig")
        {
            if (string.IsNullOrEmpty(cfgName))
                throw new ArgumentNullException("声明的配置参数名称为空 in DeclearCfgParam()");
            if (cfgName == "StationBasePrivateConfig")
                throw new ArgumentException("声明的配置参数名称不能为:\"StationBasePrivateConfig\" in DeclearCfgParam()");
            if (string.IsNullOrEmpty(category))
                throw new ArgumentException("声明的配置参数类别名不能为空 in DeclearCfgParam()");
            if (dictCfgParamDecleared.ContainsKey(cfgName))
                throw new ArgumentException("重复申明配置参数,Name = " + cfgName);
            dictCfgParamDecleared.Add(cfgName, new object[] { category, JFParamDescribe.Create(cfgName,cfgType,JFValueLimit.NonLimit,null) });
           
        }

        /// <summary>
        /// 获取所有已声明配置参数的类别名称
        /// </summary>
        /// <returns></returns>
        public List<string> AllCfgParamCategories()
        {
            List<string> ret = new List<string>();
            foreach (KeyValuePair<string, object[]> kv in dictCfgParamDecleared)
                if (!ret.Contains(kv.Value[0] as string))
                    ret.Add(kv.Value[0] as string);
            return ret;
        }

        /// <summary>
        /// 获取某一个类别下的所有配置参数名
        /// </summary>
        /// <param name="category"></param>
        /// <returns></returns>
        public List<string> AllCfgParamNamesInCategory(string category)
        {
            List<string> ret = new List<string>();
            foreach (KeyValuePair<string, object[]> kv in dictCfgParamDecleared)
                if (kv.Value[0] as string == category)
                    ret.Add(kv.Key);
            return ret;
        }



        public void DeclearCfgParam(JFParamDescribe paramDescribe,string category)
        {
            if (string.IsNullOrEmpty(paramDescribe.DisplayName))
                throw new ArgumentNullException("声明的配置参数名称为空 in DeclearCfgParam()");
            if (paramDescribe.DisplayName == "StationBasePrivateConfig")
                throw new ArgumentException("声明的配置参数名称不能为:\"StationBasePrivateConfig\" in DeclearCfgParam()");
            if (string.IsNullOrEmpty(category))
                throw new ArgumentException("声明的配置参数类别名不能为空 in DeclearCfgParam()");
            if (dictCfgParamDecleared.ContainsKey(paramDescribe.DisplayName))
                throw new ArgumentException("重复申明配置参数,Name = " + paramDescribe.DisplayName);
            dictCfgParamDecleared.Add(paramDescribe.DisplayName, new object[] { category, paramDescribe });
        }


        /// <summary>
        /// 配置项是否为工站内注册（不可删除）
        /// </summary>
        /// <param name="cfgName"></param>
        /// <returns></returns>
        public bool IsCfgDecleared(string cfgName)
        {
            return dictCfgParamDecleared.ContainsKey(cfgName);
        }

        /// <summary>
        /// 获取配置项的类型描述信息
        /// </summary>
        /// <param name="cfgName"></param>
        /// <returns></returns>
        public JFParamDescribe GetCfgParamDescribe(string cfgName)
        {
            if(dictCfgParamDecleared.ContainsKey(cfgName)) //工站(声明的)固有配置属性
                return dictCfgParamDecleared[cfgName][1] as JFParamDescribe;
            else // 从配置界面上动态添加的配置
            {
                if(!_cfg.ContainsItem(cfgName))
                    throw new ArgumentException(string.Format("GetCfgParamDescribe(cfgName,...) failed by cfgName = \"{0}\" is not contained in StationName = \"{1}\"", cfgName, Name));
                return JFParamDescribe.Create(cfgName, _cfg.GetItemValue(cfgName).GetType(), JFValueLimit.NonLimit, null);
            }

        }

        /// <summary>
        /// 
        /// </summary>
        /// <param name="cfgName"></param>
        /// <param name="cfgValue"></param>
        public void SetCfgParamValue(string cfgName,object cfgValue)
        {
            
            //if (!dictCfgParamDecleared.ContainsKey(cfgName))
            //    throw new ArgumentException(string.Format("SetCfgParam(cfgName,...) failed by cfgName = \"{0}\" is not contained by DictCfgParamDecleared,StationName = \"{1}\"", cfgName, Name));
            //if(null == cfgValue)
            //{
            //    if(!IsNullableType((dictCfgParamDecleared[cfgName][1] as JFParamDescribe).ParamType))
            //        throw new ArgumentException(string.Format("SetCfgParam(cfgName = \"{0}\",cfgValue = null) failed by cfgType ={1}  is not nullable type,StationName = \"{2}\"", cfgName, (dictCfgParamDecleared[cfgName][1] as Type).Name, Name));
            //}
            //else
            //{
            //    if(cfgValue.GetType() != (dictCfgParamDecleared[cfgName][1] as JFParamDescribe).ParamType)
            //        throw new ArgumentException(string.Format("SetCfgParam(cfgName = \"{0}\",cfgValue ) failed by cfgType ={1}  isnot equal {2},StationName = \"{3}\"", cfgName, cfgValue.GetType().Name,(dictCfgParamDecleared[cfgName][1] as Type).Name, Name));

            //}
            if (IsInitOK) //已经初始化完成
                _cfg.SetItemValue(cfgName, cfgValue);
            else //调用时未初始化（构造函数中）
            {
                if (dictCfgParamDecleared.ContainsKey(cfgName))
                {
                    object[] oa = dictCfgParamDecleared[cfgName];
                    dictCfgParamDecleared[cfgName] = new object[] { oa[0], oa[1], cfgValue };
                }
                else
                    _cfg.SetItemValue(cfgName, cfgValue);
            }
        }


        public object GetCfgParamValue(string cfgName)
        {
            //if (!dictCfgParamDecleared.ContainsKey(cfgName))
            //    throw new ArgumentException(string.Format("GetCfgParam(cfgName) failed by cfgName = \"{0}\" is not contained by DictCfgParamDecleared,StationName = \"{1}\"", cfgName, Name));
            if(!IsInitOK)
            {
                if(_cfg.ContainsItem(cfgName)) //如果配置中已包含
                    return _cfg.GetItemValue(cfgName);

                if (dictCfgParamDecleared.ContainsKey(cfgName)) //如果是声明的（固有）参数项
                {
                    object[] oa = dictCfgParamDecleared[cfgName];
                    if (oa.Length > 2)
                        return oa[2];
                    else
                        return DefaultValueFromType((oa[1] as JFParamDescribe).ParamType);
                }

                return null;
            }
            return _cfg.GetItemValue(cfgName);
        }


        Dictionary<string,JFMethodFlowBox> _dictMethodFlowBoxes = new Dictionary<string, JFMethodFlowBox>(); //所有正在异步运行的方法流容器



        #region  工站内方法流操作



        bool _IsWorkStatusRunning(JFWorkStatus ws)
        {
            return (ws == JFWorkStatus.Running || 
                    ws == JFWorkStatus.Pausing || 
                    ws == JFWorkStatus.Interactiving 
                    ); 
        }





        /// <summary>
        /// 同步运行一个（工站内定义）的工作流
        /// 函数内部会响应退出，暂停，恢复指令
        /// </summary>
        /// <param name="wfName">站内工作流名称</param>
        /// <param name="rounds">循环运行的次数</param>
        /// <returns></returns>
        public bool SynchRunWorkFlow(string wfName ,int rounds, out string errorInfo)
        {
            if (!AsynchRunWorkFlow(wfName, rounds, out errorInfo))
                return false;
            if (!WaitWorkFlowDone(wfName, -1, out errorInfo))
                return false;
            return true;
        }
        

        /// <summary>
        /// 异步运行一个(工站内定义的)工作流
        /// </summary>
        /// <param name="wfName">工作流名称</param>
        /// <param name="rounds">运行次数</param>
        /// <param name="errorInfo">启动错误信息</param>
        /// <returns></returns>
        public bool AsynchRunWorkFlow(string wfName,int rounds,out string errorInfo)
        {
            errorInfo = "Unknown-Error";
            if (!ContainWorkFlow(wfName))
            {
                errorInfo = "工站内部未包含工作流:名称=" + wfName;
                return false;
            }
            JFMethodFlow mf = GetWorkFlow(wfName);
            JFMethodFlowBox mfb = null;
            lock (_dictMethodFlowBoxes)//先锁大
            {
                if (!_dictMethodFlowBoxes.ContainsKey(wfName))
                {
                    mfb = new JFMethodFlowBox();
                    mfb.SetMethodFlow(mf);
                    _dictMethodFlowBoxes.Add(wfName, mfb);
                }
                else
                    mfb = _dictMethodFlowBoxes[wfName];
                Monitor.Enter(mfb);//再锁小
            }

            bool ret = false;
            do
            {
                if (_IsWorkStatusRunning(mfb.CurrWorkStatus))
                {
                    errorInfo = "当前状态:" + mfb.CurrWorkStatus;
                    break;
                }

                mf.Reset();
                mfb.RunLoops = rounds;
                JFWorkCmdResult cmdRet = mfb.Start();
                if (cmdRet != JFWorkCmdResult.Success)
                {
                    errorInfo = "启动工作流失败,Command Return:" + cmdRet;
                    break;
                }
                ret = true;
                errorInfo = "Success";
            } while (false);
            Monitor.Exit(mfb);
            return ret;
        }

        /// <summary>
        /// 暂停一个(异步)执行中的工作流
        /// </summary>
        /// <param name="wfName"></param>
        /// <returns></returns>
        public bool PauseWorkFlow(string wfName,out string errorInfo)
        {
            errorInfo = "Unknown-Error";
            if (!ContainWorkFlow(wfName))
            {
                errorInfo = "工站内部未包含工作流:名称=" + wfName;
                return false;
            }
            JFMethodFlowBox mfb = null;
            lock (_dictMethodFlowBoxes)//先锁大
            {
                if (!_dictMethodFlowBoxes.ContainsKey(wfName))
                {
                    errorInfo = "工作流未启动";
                    return false;
                }
                else
                    mfb = _dictMethodFlowBoxes[wfName];
                Monitor.Enter(mfb);//再锁小
            }
            if(mfb.CurrWorkStatus == JFWorkStatus.Pausing) //
            {
                errorInfo = "Success";
                Monitor.Exit(mfb);
                return true;
            }
            JFWorkCmdResult wcr = mfb.Pause(2000);
            if(wcr != JFWorkCmdResult.Success)
            {
                errorInfo = "执行暂停失败，ErrorCode:" + wcr;
                Monitor.Exit(mfb);
                return true;
            }

            errorInfo = "Success";
            Monitor.Exit(mfb);
            return true;

        }


        /// <summary>
        /// 恢复一个异步执行中的工作流
        /// </summary>
        /// <param name="wfName"></param>
        /// <returns></returns>
        public bool ResumeWorkFlow(string wfName,out string errorInfo)
        {
            errorInfo = "Unknown-Error";
            if (!ContainWorkFlow(wfName))
            {
                errorInfo = "工站内部未包含工作流:名称=" + wfName;
                return false;
            }
            JFMethodFlowBox mfb = null;
            lock (_dictMethodFlowBoxes)//先锁大
            {
                if (!_dictMethodFlowBoxes.ContainsKey(wfName))
                {
                    errorInfo = "工作流未启动";
                    return false;
                }
                else
                    mfb = _dictMethodFlowBoxes[wfName];
                Monitor.Enter(mfb);//再锁小
            }
            if (mfb.CurrWorkStatus == JFWorkStatus.Running) //
            {
                errorInfo = "Success";
                Monitor.Exit(mfb);
                return true;
            }

            JFWorkCmdResult wcr = mfb.Resume(2000);
            if (wcr != JFWorkCmdResult.Success)
            {
                errorInfo = "恢复运行失败，ErrorCode:" + wcr;
                Monitor.Exit(mfb);
                return true;
            }

            errorInfo = "Success";
            Monitor.Exit(mfb);
            return true;
        }

        public void StopWorkFlow(string wfName)
        {
            if (!ContainWorkFlow(wfName))
                return;
            JFMethodFlowBox mfb = null;
            lock (_dictMethodFlowBoxes)//先锁大
            {
                if (!_dictMethodFlowBoxes.ContainsKey(wfName))
                    return;
                
                else
                    mfb = _dictMethodFlowBoxes[wfName];
                Monitor.Enter(mfb);//再锁小
            }
            if (!_IsWorkStatusRunning(mfb.CurrWorkStatus))
            {
                Monitor.Exit(mfb);
                return;
            }
            JFWorkCmdResult wcr = mfb.Stop(2000);
            if (wcr != JFWorkCmdResult.Success)
                mfb.Abort();

            Monitor.Exit(mfb);
            return;

        }


        /// <summary>
        /// 等待一个异步执行的工作流完成
        /// </summary>
        /// <param name="milliSecondsTimeout"></param>
        /// <param name="errorInfo"></param>
        /// <returns></returns>
        public bool WaitWorkFlowDone(string wfName,int milliSecondsTimeout,out string errorInfo)
        {
            errorInfo = "Unknown-Error";
            if (!ContainWorkFlow(wfName))
            {
                errorInfo = "工站内部未包含工作流:名称=" + wfName;
                return false;
            }
            JFMethodFlowBox mfb = null;
            lock (_dictMethodFlowBoxes)//先锁大
            {
                if (!_dictMethodFlowBoxes.ContainsKey(wfName))
                {
                    errorInfo = "工作流未启动";
                    return false;
                }
                else
                    mfb = _dictMethodFlowBoxes[wfName];
               
            }
            if(!_IsWorkStatusRunning(mfb.CurrWorkStatus))
            {
                errorInfo = "Success";
                return true;
            }
            DateTime startTime = DateTime.Now;
            while(true)
            {
                if(mfb.CurrWorkStatus == JFWorkStatus.NormalEnd || mfb.CurrWorkStatus == JFWorkStatus.CommandExit)
                {
                    errorInfo = "Success";
                    return true;
                }
                if(!_IsWorkStatusRunning(mfb.CurrWorkStatus))
                {
                    errorInfo = "工作流运行错误:" + mfb.CurrWorkStatus;
                    return false;
                }
                DateTime currTime = DateTime.Now;
                if (IsInWorkThread())//如果在主线程中运行，需要检查是否有指令到达
                    CheckCmd(CycleMilliseconds);
                TimeSpan ts = DateTime.Now - startTime;
                if(milliSecondsTimeout >=0 && ts.TotalMilliseconds >= milliSecondsTimeout)
                {
                    errorInfo = "等待超时";
                    return false;
                }
            }
        }


        /// <summary>
        /// 暂停所有执行中的工作流
        /// </summary>
        /// <param name="errorInfo"></param>
        /// <returns></returns>
        protected bool PauseAllExcuteWorkFlow(out string errorInfo)
        {
            errorInfo = "Success";
            foreach (JFMethodFlowBox mfb in _dictMethodFlowBoxes.Values)
            {
                int timeoutMilliSeconds = mfb.CycleMilliseconds * 5;
                if (timeoutMilliSeconds < 0 && timeoutMilliSeconds > 2000)
                    timeoutMilliSeconds = 2000;
                JFWorkCmdResult ret = mfb.Pause(timeoutMilliSeconds);
                if (JFWorkCmdResult.Success != ret)
                {
                    errorInfo = "暂停工作流:\"" + mfb.Name + "\"失败，ErrorCode = " + ret;
                    return false;
                }
            }
            return true;
        }

        /// <summary>
        /// 恢复所有暂停的工作流
        /// </summary>
        /// <param name="errorInfo"></param>
        /// <returns></returns>
        protected bool ResumeAllExcuteWorkFlow(out string errorInfo)
        {
            errorInfo = "Success";
            foreach (JFMethodFlowBox mfb in _dictMethodFlowBoxes.Values)
            {
                int timeoutMilliSeconds = mfb.CycleMilliseconds * 5;
                if (timeoutMilliSeconds < 0 && timeoutMilliSeconds > 2000)
                    timeoutMilliSeconds = 2000;
                JFWorkCmdResult ret = mfb.Resume(timeoutMilliSeconds);
                if (JFWorkCmdResult.Success != ret)
                {
                    errorInfo = "恢复工作流:\"" + mfb.Name + "\"失败，ErrorCode = " + ret;
                    return false;
                }
            }
            return true;
        }

        protected void StopAllExcuteWorkFlow()
        {
            foreach (JFMethodFlowBox mfb in _dictMethodFlowBoxes.Values)
            {
                int timeoutMilliSeconds = mfb.CycleMilliseconds * 5;
                if (timeoutMilliSeconds < 0 && timeoutMilliSeconds > 2000)
                    timeoutMilliSeconds = 2000;
                JFWorkCmdResult ret = mfb.Stop(timeoutMilliSeconds);
                if (JFWorkCmdResult.Success != ret)
                    mfb.Abort();
                
            }
        }





        #endregion




        protected virtual void NotifyProductFinished(int passCount, string[] passIDs, int NGCount, string[] ngIDs, string[] NGInfo)
        {
            EventProductFinished?.Invoke(this, passCount, passIDs, NGCount, ngIDs, NGInfo);
        }

        protected virtual void NotifyCustomizeMsg(string msgCategory, object msgParam)
        {
            EventCustomizeMsg?.Invoke(this, msgCategory, msgParam);
        }



        #region 通用的工站方法

        ///// <summary>
        /////  设置DO状态
        ///// </summary>
        ///// <param name="doName">工站内配置的DO</param>
        ///// <param name="isTurnOn"></param>
        ///// <param name="errorInfo"></param>
        ///// <returns></returns>
        //bool SetDO(string doName,bool isTurnOn,out string errorInfo)
        //{
        //    errorInfo = "Unknown error";
        //    return false;
        //}


        //bool WaitDO(string doName,bool isTurnOn)

        #endregion


    }
}
